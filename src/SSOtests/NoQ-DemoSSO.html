<html>
<head>

<script src="http://cdn.kendostatic.com/2014.3.1316/js/jquery.min.js"></script>
<script src="/UnitTests/src/progress.jsdo.js"></script>


<script src="./src/progress.js"></script>
<script src="./src/progress.util.js"></script>
<script src="./src/progress.auth.js"></script>
<script src="./src/progress.session.js"></script>


</head>
<body>

<div id="outdiv"/>
<br/>
<br/>
   TEST OUTPUT
<br/>
 
<script>



(function () {
    "use strict";
    
    var 
        actualOutputMsgs = [],
        authProvider;

    startSimpleTest();
    
    function startSimpleTest() {
        actualOutputMsgs.push("*");
        actualOutputMsgs.push("* * * * * * * * * * * * * * * * * * simpleTest * * * * * * * * * * * * * *");
            
        try {
            authProvider = new progress.data.AuthenticationProvider(
                // "http://nbbedwhenshaw3.bedford.progress.com:8810/TS2/",
                "http://nbbedwhenshaw3.bedford.progress.com:8810/TokenServer/",
                // "",

                // "sso");
                // "SSO");
                // "");
                progress.data.Session.AUTH_TYPE_SSO);

            actualOutputMsgs.push("hasCredential before login: " + authProvider.hasCredential());
            actualOutputMsgs.push("hasRefreshToken before login: " + authProvider.hasRefreshToken());
                
            authProvider.login("restuser", "password")
            // authProvider.login("foo", "bar")
            .done(function (ap, result, info) {
                    actualOutputMsgs.push("The authentication call succeeded.");
                    actualOutputMsgs.push("hasCredential: " + ap.hasCredential());
                    actualOutputMsgs.push("hasRefreshToken: " + ap.hasRefreshToken());
                    useTheToken();
                })
            .fail(function (ap, result, info) {
                    actualOutputMsgs.push("AuthenticationProvider login failed, result: " + result);
                    finishTest();
                });
        } catch (f) {
            actualOutputMsgs.push("BUG: Error thrown calling AuthenticationProvider constructor or login(): " + f);
            finishTest();
        }
    }
    
    function useTheToken() {
        var jsdoSessionONE,
            jsdoSessionTWO,
            jsdoSessionONEout,
            jsdoSessionTWOout;
            
        // use the token by creating a JSDOSession and calling login
        try {
            jsdoSessionONE = new progress.data.JSDOSession(
                {
                    serviceURI: "http://nbbedwhenshaw3.bedford.progress.com:8810/TokenConsumer",
                    authenticationModel : progress.data.Session.AUTH_TYPE_SSO,
                } );

            // jsdoSessionTWO = new progress.data.JSDOSession(
                // {
                    // serviceURI: "http://172.29.37.11:8810/SSOBin",
                    // authenticationModel : progress.data.Session.AUTH_TYPE_SSO,
                    // authImpl: {                           // SPECIAL FOR SSO
                               // provider: authProvider,
                               // consumer: {
                                    // tokenRequestDescriptor: {
                                        // type: "header",
                                    // //    headerName: "X-OE-For-TDriver-Testing"
                                        // headerName: "X-OE-CLIENT-CONTEXT-ID"
                                    // }
                                // }
                    // }
                // } );

            jsdoSessionONE.connect(authProvider) 
            .then(function (jsdosession, result, info) {
                actualOutputMsgs.push("ONE: connected");
                return jsdosession.addCatalog("http://nbbedwhenshaw3.bedford.progress.com:8810/TokenConsumer/static/TokenConsumerService.json");
            })
            .then(function (jsdosession, result, info) {
                var jsdo;
                actualOutputMsgs.push("ONE: got catalog");
                jsdo = new progress.data.JSDO("Customer");
                return jsdo.fill("CustNum < 20");
            })
            .then(function(jsdo, success, request) {
                actualOutputMsgs.push("ONE: fill succeeded");
                
                // test for fix of bug in progress.data.LocalStorage (bad error message when localStorage doesn't exit)
                //jsdo.saveLocal();
                return jsdoSessionONE.disconnect();
            })
            .then(
                function (jsdosession, result, info) {
                    actualOutputMsgs.push("ONE: JSDOSession disconnect succeeded");
                    authProvLogout(jsdosession);    // may need to move this out after adding 2nd jsdosession
                },
                function (jsdosession, result, info) { // handles all errors
                    actualOutputMsgs.push("ONE: got an error somewhere");
                    authProvLogout(jsdosession);    // may need to move this out after adding 2nd jsdosession    
                }
            );
  
            // jsdoSessionTWO.login()  // no credentials - token is being used 
            // .then(function (jsdosession, result, info) {
                // actualOutputMsgs.push("TWO: logged in");
                // return jsdosession.addCatalog("http://172.29.37.11:8810/SSOBin/static/SSOBinService.json");
            // })
            // .then(function (jsdosession, result, info) {
                // var jsdo;
                // actualOutputMsgs.push("TWO: got catalog");
                // jsdo = new progress.data.JSDO("SSOBinBE");
                // return jsdo.fill("BinNum < 750");
            // })
            // .then(function(jsdo, success, request) {
                // actualOutputMsgs.push("TWO: fill succeeded");
                // return jsdoSessionTWO.logout();
            // })
            // .then(
                // function (jsdosession, result, info) {
                    // actualOutputMsgs.push("TWO: logout succeeded");
                    // finishTest();
                // },
                // function (jsdosession, result, info) { // handles all errors
                    // actualOutputMsgs.push("TWO: got an error somewhere");
                    // finishTest();
                // }
            // );
            
            
        } catch(e) {
            actualOutputMsgs.push("Error using the token: " + e);
            finishTest();    
        }
        
    }


    function authProvLogout(jsdosession) {
        // jsdosession.authImpl.provider.logout()
        authProvider.logout()
        .done( function(ap, result, info) {
            actualOutputMsgs.push("AuthenticationProvider.logout succeeded");
            actualOutputMsgs.push("hasCredential after logout: " + ap.hasCredential());
            actualOutputMsgs.push("hasRefreshToken after logout: " + ap.hasRefreshToken());
        })
        .fail( function(ap, result, info) {
            actualOutputMsgs.push("AuthenticationProvider.logout FAILED");
            
            actualOutputMsgs.push("info.errorObject: " + info.errorObject);
            actualOutputMsgs.push("info.xhr: " + info.xhr);
            
            actualOutputMsgs.push("hasCredential after failed logout: " + ap.hasCredential());
            actualOutputMsgs.push("hasRefreshToken after failed logout: " + ap.hasRefreshToken());        
        })
        .always( function(ap, result, info) {
            finishTest();
        });
    }
    
    function finishTest() {
        var lineIdx,
            charIdx,
            msgs = [],
            outputString;

       // spit out the actual output. Also returns the output as a string for easy comparison
       // with the correct output, which was set into correctOutputString at the beginning of the test
        outputString = outputMsgs(actualOutputMsgs, document.getElementById("outdiv"));

        msgs.push(" ");
        outputMsgs(msgs, document.getElementById("outdiv"));
    }

    function outputMsgs(msgs, writeElement) {
        var arrayLength,
            arrayIndex,
            outMsg = "",
            consolemsg = " ";

        if (writeElement) {
             outMsg = writeElement.innerHTML;
        }
        
        arrayLength = msgs.length;
        for (arrayIndex = 0; arrayIndex < arrayLength; arrayIndex = arrayIndex + 1) {
            outMsg = outMsg + "<br>" + msgs[arrayIndex];
            consolemsg = consolemsg + "\n" + msgs[arrayIndex];
        }
        
        if (writeElement) {
            writeElement.innerHTML = outMsg;
        }
        
        
        console.log(consolemsg); 
        return consolemsg;
    }

}());

</script>

</body>

</html>
