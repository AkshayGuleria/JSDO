<html>
<head>

<script src="http://cdn.kendostatic.com/2014.3.1316/js/jquery.min.js"></script>
<script src="./progress.jsdo.js"></script>

<!--
<script src="/progress.js"></script>
-->

<script src="./progress.session.js"></script>

<!--
<script src="/progress.auth.js"></script>
-->

</head>
<body>
<div id="correct">
    CORRECT OUTPUT<br/>
<br/>
</div>     

<div id="outdiv"/>
<br/>
<br/>
   TEST OUTPUT
<br/>
 
<script>



(function () {
    "use strict";
    
    /*global progress, console, sessionStorage, document  */
    /*global startSimpleTest, simpleTest, finishTest, cleanStorage, logResult, outputMsgs, callFill*/
    /*global handleFillResponse, callLogout, handleLogoutResponse*/
    
    var authenticationSettings = {
            authenticationURI : "http://nbbedwhenshaw2.bedford.progress.com:8810/TokenServer0331/static/auth/j_spring_security_check",
            tokenResponseDescriptor: {
                type: progress.data.Session.HTTP_HEADER
                //headerName: "X-OE-CLIENT-CONTEXT-ID"
              //  headerName: 7   // error test
            }
        },
        jsdoSettings = {
            name: "FIRST",
            serviceURI: "http://nbbedwhenshaw2.bedford.progress.com:8810/SSOwh0331",
            authenticationModel : progress.data.Session.AUTH_TYPE_OECP,
            authImpl: {
                        provider: undefined   // set after new of AuthenticationProvider
            },
            catalogURIs: [
                "http://nbbedwhenshaw2.bedford.progress.com:8810/SSOwh0331/static/SSOwh0331Service.json"
            ],
            resource: "Customer",
            fillFilter: "CustNum < 20",    
        },
        jsdoSettingsTwo = {
            name: "SECOND",
            serviceURI: "http://nbbedwhenshaw2.bedford.progress.com:8810/SSOwhTwo",
            authenticationModel : progress.data.Session.AUTH_TYPE_OECP,
            authImpl: {
                        provider: undefined   // set after new of AuthenticationProvider
            },
            catalogURIs: [
                "http://nbbedwhenshaw2.bedford.progress.com:8810/SSOwhTwo/static/SSOwhTwoService.json"
            ],
            resource: "Bin",
            fillFilter: "BinNum < 750",    
        },
        correctOutputString,
        correctOutputMsgs = [
            "*",
            "* * * * * * * * * * * * * * * * * * simpleTest * * * * * * * * * * * * * *",
            "The authentication call succeeded.",
            "token: TOKEN HAS A VALUE",
            "FIRST login result: 1",
            "token: TOKEN HAS A VALUE",
            "FIRST addCatalog result: 1",
            "token: TOKEN HAS A VALUE",
            "FIRST jsdo.fill result: true",
            "SECOND login result: 1",
            "token: TOKEN HAS A VALUE",
            "SECOND addCatalog result: 1",
            "token: TOKEN HAS A VALUE",
            "SECOND jsdo.fill result: true",
            "SECOND logout(): 1",
            "FIRST logout(): 1",
            "logouts completed",
            "token: null",
        ],
        actualOutputMsgs = [],
        // runCount = 0,        
        msgAuthSucceeded = "The authentication call succeeded.",
        msgBUGUnexpectedFailure = "BUG: Call to authenticate() failed unexpectedly",
        authProvider,
        jsdoSession,
        jsdoSessionTwo,
        numlogout;

    // Put the correct output on the page for convenient reference. Also returns the output as a string
    // to save for comparison with the actual output later
    correctOutputString = outputMsgs(correctOutputMsgs, document.getElementById("correct"));

    startSimpleTest();

    
    function startSimpleTest() {
        actualOutputMsgs.push("*");
        actualOutputMsgs.push("* * * * * * * * * * * * * * * * * * simpleTest * * * * * * * * * * * * * *");
        cleanStorage();
            
        try {
            authProvider = new progress.data.AuthenticationProvider(
                                        authenticationSettings.authenticationURI,
                                        authenticationSettings);
                
            authProvider.authenticate("restuser", "password")
            .done(function (ap, result, info) {
                    logResult(msgAuthSucceeded, null, authenticationSettings);
                    loginAddCat(jsdoSettings);
                })
            .fail(function (ap, result, info) {
                    logResult(msgBUGUnexpectedFailure + ", result: " + result, info.errorObject,
                              authenticationSettings);
                    finishSimpleTest();
                });
        } catch (f) {
            logResult("BUG: Error thrown calling authenticate(): ", f, authenticationSettings);
            finishSimpleTest();
        }
    }
    
    function finishSimpleTest() {
        finishTest();
        // if (runCount < 2) {
            // startSimpleTest();
        // }
    }
    
    function loginAddCat(jsdosettings) {
        var promise,
            jsdosession;
            
        // ERROR TEST SETTING PROVIDER PROPERTY TO A VALUE THAT IS NOT AN OBJECT
        //jsdoSettings.authImpl.provider = "foo";
        jsdosettings.authImpl.provider = authProvider;
        // use the token by creating a JSDOSession and calling login
        try {
            if (jsdosettings.name === "FIRST") {
                jsdosession = jsdoSession = new progress.data.JSDOSession(jsdosettings);
                jsdosession.__appdata_name = jsdosettings.name;
            } else {
                jsdosession = jsdoSessionTwo = new progress.data.JSDOSession(jsdosettings);            
                jsdosession.__appdata_name = jsdosettings.name;
            }
              // ERROR TEST SENDING BAD TOKEN on login
              //  sessionStorage.setItem(authenticationSettings.authenticationURI, "12345");
            jsdosession.login()
            .done(function (jsdosession, result, info) {
                logResult(jsdosession.__appdata_name + " login result: " + result,
                      null,
                      authenticationSettings);
                  // ERROR TEST SENDING BAD TOKEN  ON addCatalog
                  //  sessionStorage.setItem(authenticationSettings.authenticationURI, "12345");
                jsdosession.addCatalog(jsdosettings.catalogURIs)
                .done(function (jsdosession, result, info) {
                    logResult(jsdosession.__appdata_name + " addCatalog result: " + result,
                          null,
                          authenticationSettings);
                    callFill(jsdosession, jsdosettings);
                })
                .fail(function (jsdosession, result, info) {
                    logResult(jsdosession.__appdata_name + " addCatalog failed, result: " + result,
                          info.errorObject,
                          authenticationSettings);
                    finishSimpleTest();
                });
            })
            .fail(function (jsdosession, result, info) {
                logResult(jsdosession.__appdata_name + " login result: " + result,
                      info.errorObject,
                      authenticationSettings);
                finishSimpleTest();
            });
        } catch (e) {
            logResult("BUG: Error thrown trying to create JSDOSession and log in",
                      e,
                      authenticationSettings);
        }
    }

    function callFill(jsdosession, jsdosettings) {
        var promise,
            jsdo;

        try {
            jsdo = new progress.data.JSDO(jsdosettings.resource);
            jsdo._appjsdosession = jsdosession;
          // TEST SENDING BAD TOKEN ON JSDO fill REQUEST -- uncomment
          //  sessionStorage.setItem(authenticationSettings.authenticationURI, "12345");
            promise = jsdo.fill(jsdosettings.fillFilter);
            promise.always(handleFillResponse);
        } catch (e) {
            actualOutputMsgs.push(e);
            finishSimpleTest();
        }
    }

    function handleFillResponse(jsdo, success, request) {
        actualOutputMsgs.push(jsdo._appjsdosession.__appdata_name + " jsdo.fill result: " + success);
        
        if (jsdo._appjsdosession.__appdata_name === "FIRST") {
            loginAddCat(jsdoSettingsTwo);
        } else {
            callLogout(jsdo._appjsdosession);
        }
    }


    function callLogout(jsdosession) {
        var promise;
        
        numlogout += 1;
        promise = jsdosession.logout();
        promise.always( handleLogoutResponse );
    }
        
    function handleLogoutResponse(session, result, info ) { 

        actualOutputMsgs.push(session.__appdata_name + " logout(): " + result);

        if (session.__appdata_name === "SECOND") {
            callLogout(jsdoSession);
        } else {
            session.authImpl.provider.invalidate();
            logResult("logouts completed", null, authenticationSettings);
            finishSimpleTest();
        }
        
    }

    // clean up storage (can delete this when we add the invalidate() method to AuthenticationProvider)
    function cleanStorage() {
        sessionStorage.removeItem(authenticationSettings.authenticationURI);
    }
    
    // 
    function logResult(resultMsg, errorObject, authenticationSettings) {
        var id = authenticationSettings.id || authenticationSettings.authenticationURI,
            token;
        actualOutputMsgs.push(resultMsg);
        if (errorObject) {
            actualOutputMsgs.push("errorObject: " + errorObject);
        }
        token = sessionStorage.getItem(id);
        if (token) {
            token = "TOKEN HAS A VALUE";
        }
        actualOutputMsgs.push("token: " + token);
    }
    
    function finishTest() {
        var lineIdx,
            charIdx,
            msgs = [],
            outputString;
        
       // spit out the actual output. Also returns the output as a string for easy comparison
       // with the correct output, which was set into correctOutputString at the beginning of the test
        outputString = outputMsgs(actualOutputMsgs, document.getElementById("outdiv"));

        msgs.push(" ");
        if (outputString === correctOutputString) {
            msgs.push("       TEST PASSED");
        } else {
            msgs.push("       TEST FAILED !!!!!!!!!!!!!  see console for details");
            // uncomment this to identify the correct and actual output lines that don't match 
               
            for (lineIdx = 0; lineIdx < correctOutputMsgs.length; lineIdx += 1) {
                if (actualOutputMsgs[lineIdx] !== correctOutputMsgs[lineIdx]) {
                    console.log("MISMATCH ON LINE " + (lineIdx + 1) + "\n   correct: " +
                                correctOutputMsgs[lineIdx] +
                                "\n   actual: " + actualOutputMsgs[lineIdx]);
                    // uncomment this to identify the correct and actual output characters that don't match 

                    for (charIdx = 0; charIdx < correctOutputMsgs[lineIdx].length; charIdx += 1) {
                        if (actualOutputMsgs[lineIdx]) {
                            if (actualOutputMsgs[lineIdx][charIdx] !== correctOutputMsgs[lineIdx][charIdx]) {
                                console.log(charIdx + "   " + actualOutputMsgs[lineIdx][charIdx] + "   " +
                                            correctOutputMsgs[lineIdx][charIdx]);
                            }
                        }
                    }
                }
            }
            if (actualOutputMsgs.length < correctOutputMsgs.length) {
                console.log("ACTUAL OUTPUT HAS ONLY " + actualOutputMsgs.length + " lines");
            }            
            if (actualOutputMsgs.length > correctOutputMsgs.length) {
                console.log("ACTUAL OUTPUT HAS MORE LINES THAN CORRECT OUTPUT (" + actualOutputMsgs.length + " lines vs. " +
                             correctOutputMsgs.length + ")");
            }
        }
        outputMsgs(msgs, document.getElementById("outdiv"));
    }

    function outputMsgs(msgs, writeElement) {
        var arrayLength,
            arrayIndex,
            outMsg = "",
            consolemsg = " ";

        if (writeElement) {
             outMsg = writeElement.innerHTML;
        }
        
        arrayLength = msgs.length;
        for (arrayIndex = 0; arrayIndex < arrayLength; arrayIndex = arrayIndex + 1) {
            outMsg = outMsg + "<br>" + msgs[arrayIndex];
            consolemsg = consolemsg + "\n" + msgs[arrayIndex];
        }
        
        if (writeElement) {
            writeElement.innerHTML = outMsg;
        }
        
        
        console.log(consolemsg); 
        return consolemsg;
    }

}());

</script>

</body>

</html>
