<html>
<head>

<script src="http://cdn.kendostatic.com/2014.3.1316/js/jquery.min.js"></script>
<script src="./progress.jsdo.js"></script>

<!--
<script src="/progress.js"></script>
-->

<script src="./progress.session.js"></script>

<!--
<script src="/progress.auth.js"></script>
-->

</head>
<body>
<div id="correct">
    CORRECT OUTPUT<br/>
<br/>
</div>     

<div id="outdiv"/>
<br/>
<br/>
   TEST OUTPUT
<br/>
 
<script>



(function () {
    "use strict";
    
    /*global progress, console, sessionStorage, document  */
    /*global startSimpleTest, simpleTest, finishTest, cleanStorage, logResult, outputMsgs, callFill*/
    /*global handleFillResponse, callLogout, handleLogoutResponse*/
    
    var secure = false,
//        host = "nbbedwhenshaw2",
        host = "VM",
        
        nbbedwhenshaw2Settings = {
            host: "nbbedwhenshaw.bedford.progress.com",
            dataProvider1: "SSOwh0331",
            resource1: "Customer",
            dataProvider2: "SSOwhTwo",
            resource2: "Bin",
            dataProvider2HeaderName: "X-OE-Client-Context-Id"
        },
        vmSettings = {
            host: "172.29.37.63",
            dataProvider1: "SSOConsumer",
            resource1: "SSOConsumerBE",
            dataProvider2: "SSOBin",
            resource2: "SSOBinBE",
            dataProvider2HeaderName: "X-OE-For-TDriver-Testing"
        },
        hostSettings,
        scheme,
        port,
        authenticationSettings = {
            tokenResponseDescriptor: {
                type: progress.data.Session.HTTP_HEADER
            }
        },
        jsdoSettings = {
            authenticationModel : progress.data.Session.AUTH_TYPE_OECP,
            authImpl: {
                        provider: undefined   // set after new of AuthenticationProvider
               }
        },

        correctOutputString,
        correctOutputMsgs = [
            "*",
            "* * * * * * * * * * * * * * * * * * log out with no token * * * * * * * * * * * * * *",
            "The authentication call succeeded.",
            "token: TOKEN HAS A VALUE",
            "Login result: 1",
            "token: TOKEN HAS A VALUE",
            "jsdo.fill result: true",
            "Error thrown calling JSDOSession.logout() : ",
            "errorObject: Error: JSDOSession: Unable to send logout request. JSDOSession: The AuthenticationProvider needs to be managing a valid token.",
            "token: null"
        ],
        actualOutputMsgs = [],
        resource = "Customer",
        fillFilter = "CustNum < 20",    
        authProvider,
        jsdoSession,
        msgAuthSucceeded = "The authentication call succeeded.",
        msgBUGUnexpectedFailure = "BUG: Call to authenticate() failed unexpectedly";

    if (secure) {
        scheme = "https";
        port = "8811";
    } else {
        scheme = "http";
        port = "8810";
    } 

    if (host === "VM") {
        hostSettings = vmSettings;
    } else {
        hostSettings = nbbedwhenshaw2Settings;
    }
    
    authenticationSettings.authenticationURI =
        scheme + "://" + hostSettings.host + ":" + port + "/TokenServerShort/static/auth/j_spring_security_check";
    jsdoSettings.serviceURI =
        scheme + "://" + hostSettings.host + ":" + port + "/" + hostSettings.dataProvider1;
    jsdoSettings.catalogURIs = [
        scheme + "://" + hostSettings.host + ":" + port + "/" + hostSettings.dataProvider1 + "/static/" + 
                hostSettings.dataProvider1 + "Service.json"
        ];
    resource = hostSettings.resource1;
    

    // Put the correct output on the page for convenient reference. Also returns the output as a string
    // to save for comparison with the actual output later
    correctOutputString = outputMsgs(correctOutputMsgs, document.getElementById("correct"));

    function startSimpleTest() {
        actualOutputMsgs.push("*");
        actualOutputMsgs.push("* * * * * * * * * * * * * * * * * * log out with no token * * * * * * * * * * * * * *");
        simpleTest();
    }
    startSimpleTest();
    

    function finishSimpleTest() {
        finishTest();
    }
    
    function simpleTest() {
        var promise;
            
        try {
            cleanStorage();
            
            
            authProvider = new progress.data.AuthenticationProvider(
                                    authenticationSettings.authenticationURI,
                                    authenticationSettings);

            jsdoSettings.authImpl.provider = authProvider;
            
            promise = authProvider.authenticate("restuser", "password");
            promise.done(function (ap, result, info) {
                logResult(msgAuthSucceeded, null, authenticationSettings);
                // use the token by creating a JSDOSession and calling login
                try {
                    jsdoSession = new progress.data.JSDOSession(jsdoSettings);
                    jsdoSession.login()
                        .done(function (jsdosession, result, info) {
                            logResult("Login result: " + result,
                                  null,
                                  authenticationSettings);
                            jsdoSession.addCatalog(jsdoSettings.catalogURIs)
                            .done(function (jsdosession, result, info) {
                                callFill();
                            })
                            .fail(function (jsdosession, result, info) {
                                logResult("addCatalog failed, result: " + result,
                                      info.errorObject,
                                      authenticationSettings);
                                finishSimpleTest();
                            });
                        })
                        .fail(function (jsdosession, result, info) {
                            logResult("Login result: " + result,
                                  info.errorObject,
                                  authenticationSettings);
                            finishSimpleTest();
                        });
                } catch (e) {
                    logResult("BUG: Error thrown trying to create JSDOSession and log in",
                              e,
                              authenticationSettings);
                }
            });
            promise.fail(function (ap, result, info) {
                logResult(msgBUGUnexpectedFailure + ", result: " + result, info.errorObject,
                          authenticationSettings);
                finishSimpleTest();
            });
        } catch (f) {
            logResult("BUG: Error thrown calling authenticate(): ", f, authenticationSettings);
            finishSimpleTest();
        }
    }

    function callFill() {
        var promise,
            jsdo;

        try {
            jsdo = new progress.data.JSDO(resource);
            promise = jsdo.fill(fillFilter);
            promise.always(handleFillResponse);
        } catch (e) {
            actualOutputMsgs.push(e);
            finishSimpleTest();
        }
    }

    function handleFillResponse(jsdo, success, request) {
        actualOutputMsgs.push("jsdo.fill result: " + success);
        callLogout();
    }
    
    function callLogout() {
        var promise;
            
        // ERROR TEST : NO TOKEN AVAIABLE FOR logout
        cleanStorage();
        
        try {
            promise = jsdoSession.logout();
            promise.always( handleLogoutResponse );
        } catch (e) {
            logResult("Error thrown calling JSDOSession.logout() : ",
                      e,
                      authenticationSettings);
            finishSimpleTest();
        }
    }
        
    function handleLogoutResponse(session, result, info ) { 
        authProvider.invalidate();
        logResult("result of JSDOSession.logout(): " + result,
                  null,
                  authenticationSettings);

        finishSimpleTest();
    }

    // clean up storage (can delete this when we add the invalidate() method to AuthenticationProvider)
    function cleanStorage() {
        sessionStorage.removeItem(authenticationSettings.authenticationURI);
    }
    
    // 
    function logResult(resultMsg, errorObject, authenticationSettings) {
        var id = authenticationSettings.id || authenticationSettings.authenticationURI,
            token;
        actualOutputMsgs.push(resultMsg);
        if (errorObject) {
            actualOutputMsgs.push("errorObject: " + errorObject);
        }
        token = sessionStorage.getItem(id);
        if (token) {
            token = "TOKEN HAS A VALUE";
        }
        actualOutputMsgs.push("token: " + token);
    }
    
    function finishTest() {
        var lineIdx,
            charIdx,
            msgs = [],
            outputString;
        
       // spit out the actual output. Also returns the output as a string for easy comparison
       // with the correct output, which was set into correctOutputString at the beginning of the test
        outputString = outputMsgs(actualOutputMsgs, document.getElementById("outdiv"));

        msgs.push(" ");
        if (outputString === correctOutputString) {
            msgs.push("       TEST PASSED");
        } else {
            msgs.push("       TEST FAILED !!!!!!!!!!!!!  see console for details");
            // uncomment this to identify the correct and actual output lines that don't match 
               
            for (lineIdx = 0; lineIdx < correctOutputMsgs.length; lineIdx += 1) {
                if (actualOutputMsgs[lineIdx] !== correctOutputMsgs[lineIdx]) {
                    console.log("MISMATCH ON LINE " + (lineIdx + 1) + "\n   correct: " +
                                correctOutputMsgs[lineIdx] +
                                "\n   actual: " + actualOutputMsgs[lineIdx]);
                    // uncomment this to identify the correct and actual output characters that don't match 

                    for (charIdx = 0; charIdx < correctOutputMsgs[lineIdx].length; charIdx += 1) {
                        if (actualOutputMsgs[lineIdx]) {
                            if (actualOutputMsgs[lineIdx][charIdx] !== correctOutputMsgs[lineIdx][charIdx]) {
                                console.log(charIdx + "   " + actualOutputMsgs[lineIdx][charIdx] + "   " +
                                            correctOutputMsgs[lineIdx][charIdx]);
                            }
                        }
                    }
                }
            }
            if (actualOutputMsgs.length < correctOutputMsgs.length) {
                console.log("ACTUAL OUTPUT HAS ONLY " + actualOutputMsgs.length + " lines");
            }            
            if (actualOutputMsgs.length > correctOutputMsgs.length) {
                console.log("ACTUAL OUTPUT HAS MORE LINES THAN CORRECT OUTPUT (" + actualOutputMsgs.length + " lines vs. " +
                             correctOutputMsgs.length + ")");
            }
        }
        outputMsgs(msgs, document.getElementById("outdiv"));
    }

    function outputMsgs(msgs, writeElement) {
        var arrayLength,
            arrayIndex,
            outMsg = "",
            consolemsg = " ";

        if (writeElement) {
             outMsg = writeElement.innerHTML;
        }
        
        arrayLength = msgs.length;
        for (arrayIndex = 0; arrayIndex < arrayLength; arrayIndex = arrayIndex + 1) {
            outMsg = outMsg + "<br>" + msgs[arrayIndex];
            consolemsg = consolemsg + "\n" + msgs[arrayIndex];
        }
        
        if (writeElement) {
            writeElement.innerHTML = outMsg;
        }
        
        
        console.log(consolemsg); 
        return consolemsg;
    }


}());

</script>

</body>

</html>
