<html>
<head>

<script src="http://cdn.kendostatic.com/2014.3.1316/js/jquery.min.js"></script>
<!--
<script src="/UnitTests/src/progress.jsdo.js"></script>
-->

<script src="./src/progress.util.js"></script>
<script src="./src/progress.js"></script>
<script src="./src/progress.auth.js"></script>
<script src="./src/progress.session.js"></script>

</head>
<body>
<div id="correct">
    CORRECT OUTPUT<br/>
<br/>
</div>    

<div id="outdiv"/>
<br/>
<br/>
   TEST OUTPUT
<br/>


<script>

var jsdoSession,
    authProvider,
    resource = "Customer",
    msgs = [],
    authenticationSettings = {
            uri: "http://nbbedwhenshaw3:8810/TokenServer/",
            authenticationModel:  progress.data.Session.AUTH_TYPE_SSO
        },
    jsdoSettings = {serviceURI: "http://nbbedwhenshaw3:8810/TokenConsumer",
                    authenticationModel:  progress.data.Session.AUTH_TYPE_SSO,
                    catalogURIs: "http://nbbedwhenshaw3:8810/TokenConsumer/static/TokenConsumerService.json",
        },
    outputString,
    correctOutputString,
    msgs = [
        '*',
        '* * * * * * * * * * * * * * * * * * AllRequests * * * * * * * * * * * * * *',
        'AuthenticationProvider.login succeeded',
        'JSDOSession.connect succeeded',
        'JSDOSession.addCatalog result:1',
        'JSDOSession.ping result:true',
        'JSDO fill result:true',
        'JSDO saveChanges (with create) result:true',
        'JSDO saveChanges (with update) result:true',
        'JSDO saveChanges (with a delete) result:true',
        'JSDO saveChanges (setting up for Submit test) result:true',
        'JSDO saveChanges (Submit with create, update, delete) result:true',
        'JSDOSession disconnect) result:1',
        'AuthenticationProvider logout) result:1',
    ],
    jsdo,
    custNameCUD = "CUDTest";
    custNameSubmitCreate= "SubmitCreateTest";
    custNameSubmitUpdate = "SubmitUpdateTest";
    custNameSubmitDelete = "SubmitDeleteTest";

correctOutputString = outputMsgs(msgs, document.getElementById("correct") );
msgs = [];

startTest();
// end of main line of code

function startTest() {
    var lastOperationTried,
        errorObject;

    function handleThrownError(e, msg) {
        var deferred = $.Deferred();
        
        errorObject = e;
        deferred.reject(jsdoSession);
        return deferred.promise();
    }
    
    cleanStorage();

    msgs.push("*");
    msgs.push("* * * * * * * * * * * * * * * * * * AllRequests * * * * * * * * * * * * * *");
    try {
        authProvider = new progress.data.AuthenticationProvider(
                                    authenticationSettings.uri,
                                    authenticationSettings.authenticationModel);
        lastOperationTried = "AuthenticationProvider.login";    
        authProvider.login("restuser", "password")
        .then(function (ap, result, info) {
            msgs.push(lastOperationTried + " succeeded");
            lastOperationTried = "JSDOSession constructor";
            jsdoSession = new progress.data.JSDOSession(jsdoSettings);
            try {
                lastOperationTried = "JSDOSession.connect";
                return jsdoSession.connect(authProvider);
            } catch(e) {
                return handleThrownError(e);
            }
        })
        .then( function (jsdosession, result, info) {
            msgs.push(lastOperationTried + " succeeded");
            try {
                lastOperationTried = "JSDOSession.addCatalog";
                return jsdosession.addCatalog(jsdoSettings.catalogURIs );
            } catch(e) {
                return handleThrownError(e);
            }
        })
        .then( function (jsdosession, result, info) {        
            msgs.push(lastOperationTried + " result:" + result);
            try {
                lastOperationTried = "JSDOSession.ping";
                return jsdosession.ping();
            }
            catch(e) {
                return handleThrownError(e);
            }
        })
        .then(function (jsdosession, result, info ) {
            msgs.push(lastOperationTried + " result:" + result);
            try {
                lastOperationTried = "JSDO constructor";
                jsdo = new progress.data.JSDO( resource );
                lastOperationTried = "JSDO fill";
                return jsdo.fill();
            } catch(e) {
                return handleThrownError(e);
            }
        })
        .then( function (jsdo, success, request) {
            msgs.push(lastOperationTried + " result:" + success);
            try {
                jsdo.ttCustomer.add({Name: custNameCUD});
                lastOperationTried = "JSDO saveChanges (with create)";
                return jsdo.saveChanges(false);
            } catch(e) {
                return handleThrownError(e);
            }
        })
        .then( function (jsdo, success, request) {    
            var row;

            msgs.push(lastOperationTried + " result:" + success);
            try {
                row = jsdo.ttCustomer.find(function (row) {
                    return (row.data.Name === custNameCUD);
                });
                
                if (row) {
                    lastOperationTried = "JSDO saveChanges";
                    row.assign( {Name: "Updated " + row.data.Name} );
                }
                lastOperationTried = "JSDO saveChanges (with update)";
                return jsdo.saveChanges(false);
            } catch(e) {
                return handleThrownError(e);
            }
        })
        .then( function (jsdo, success, request) {
            var row;

            msgs.push(lastOperationTried + " result:" + success);
            try {
                row = jsdo.ttCustomer.find(function (row) {
                    return (row.data.Name === "Updated " + custNameCUD);
                });
                
                if (row) {
                    row.remove();
                }
                lastOperationTried = "JSDO saveChanges (with a delete)";
                return jsdo.saveChanges(false);
            } catch(e) {
                return handleThrownError(e);
            }
        })
        .then(function  (jsdo, success, request) {
            
            msgs.push(lastOperationTried + " result:" + success);

            try {
                // set up for Submit test
                jsdo.ttCustomer.add({Name: custNameSubmitUpdate});
                jsdo.ttCustomer.add({Name: custNameSubmitDelete});
                
                lastOperationTried = "JSDO saveChanges (setting up for Submit test)";
                return jsdo.saveChanges(false);
            } catch(e) {
                return handleThrownError(e);
            }
        })
        .then( function (jsdo, success, request) {
            
            msgs.push(lastOperationTried + " result:" + success);
            try {
                // test Submit
                    // add a customer
                jsdo.ttCustomer.add({Name: custNameSubmitCreate});
                    // update a customer    
                row = jsdo.ttCustomer.find(function (row) {
                    return (row.data.Name === custNameSubmitUpdate);
                });
                if (row) {
                    row.assign({Name: "Updated " + row.data.Name});
                }
                    // delete a customer    
                row = jsdo.ttCustomer.find(function (row) {
                    return (row.data.Name === custNameSubmitDelete);
                });
                if (row) {
                    row.remove();
                }

                // now actually do Submit    
                lastOperationTried = "JSDO saveChanges (Submit with create, update, delete)";
                return jsdo.saveChanges(true);  // saveChanges with useSubmit = true
            } catch(e) {
                return handleThrownError(e);
            }
        })
        .then( function  ( jsdo, success, request ) {
            msgs.push(lastOperationTried + " result:" + success);
            try {
                lastOperationTried = "JSDOSession disconnect)";
                return jsdoSession.disconnect();
            } catch(e) {
                return handleThrownError(e);
            }
        })
        .then (function (session, result, info) { 
            msgs.push(lastOperationTried + " result:" + result);

            try {
                lastOperationTried = "AuthenticationProvider logout)";
                return authProvider.logout();
            } catch (e) {
                return handleThrownError(e);
            }
        })
        .then(function (provider, result, info) { 
            msgs.push(lastOperationTried + " result:" + result);
        }, function (jsdosession, result, info) {
            var errMsg;
            
            if (errorObject) {
                errMsg = "Error thrown calling " + lastOperationTried +": " + errorObject;
            } else {
                errMsg = "Error calling " + lastOperationTried;
            }
            msgs.push(errMsg);
            if (authProvider.hasCredential()) {
                return authProvider.logout();
            } 
        })
        .always(function () {
            finishTest();
        });
    } catch (f) {
        msgs.push("BUG: Error thrown calling AuthenticationProvider.login(): " + f);
        finishTest();
    }
}


// clean up storage (can delete this when we add the invalidate() method to AuthenticationProvider)
function cleanStorage() {
    sessionStorage.removeItem(authenticationSettings.authenticationURI);
}



function finishTest() {
    var idx;
   outputString = outputMsgs(msgs, document.getElementById("outdiv") );
    
   msgs = [];    
   msgs.push(" ");
   if (outputString === correctOutputString) {
       msgs.push("       TEST PASSED ");
   }
   else {
        msgs.push("       TEST FAILED !!!!!!!!!!!!!");
        for (idx = 0; idx < outputString.length; idx += 1) {
            if (outputString[idx] !== correctOutputString[idx] ) {
                console.log(idx + "   " + outputString[idx] + "   " + correctOutputString[idx]);
            }
        }
   }
   outputMsgs( msgs, document.getElementById("outdiv") );
}



function outputMsgs(msgs, writeElement) {
    var arrayLength,
        arrayIndex,
        outMsg = "",
        consolemsg = " ";

    if (writeElement) {
         outMsg = writeElement.innerHTML;
    }
    
    arrayLength = msgs.length;
    for (arrayIndex = 0; arrayIndex < arrayLength; arrayIndex = arrayIndex + 1) {
        outMsg = outMsg + "<br>" + msgs[arrayIndex];
        consolemsg = consolemsg + "\n" + msgs[arrayIndex];
    }
    
    if (writeElement) {
        writeElement.innerHTML = outMsg;
    }
    
    
    console.log(consolemsg); 
    return consolemsg;
}



</script>

</body>

</html>
